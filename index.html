<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Case Management System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <style>
    @keyframes marquee {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    .marquee {
      display: inline-block;
      white-space: nowrap;
      animation: marquee 40s linear infinite;
    }
    .marquee:hover {
      animation-play-state: paused;
    }
    .custom-shadow {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    .input-focus {
      transition: all 0.3s ease;
    }
    .input-focus:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 8px rgba(59, 130, 246, 0.2);
    }
    .card-hover {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card-hover:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }
    .sidebar-item {
      transition: background 0.2s ease;
    }
    .sidebar-item:hover {
      background: #e0f2fe;
    }
    .tab-active {
      border-bottom: 2px solid #3b82f6;
      color: #1f2937;
      font-weight: 500;
    }
    .tab-inactive {
      border-bottom: 2px solid transparent;
      color: #6b7280;
    }
    .modal-scroll {
      max-height: 70vh;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #a0aec0 #edf2f7;
    }
    .modal-scroll::-webkit-scrollbar {
      width: 8px;
    }
    .modal-scroll::-webkit-scrollbar-track {
      background: #edf2f7;
    }
    .modal-scroll::-webkit-scrollbar-thumb {
      background: #a0aec0;
      border-radius: 4px;
    }
    .chart-container {
      position: relative;
      width: 100%;
      height: 200px;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <div id="root"></div>
  <script>
    const { useState, useEffect, useRef } = React;
    const ReactDOM = window.ReactDOM;
    const Chart = window.Chart;

    // Validate Supabase client loading
    if (!window.supabase) {
      console.error('Supabase client failed to load. Check the CDN URL or network connectivity.');
      throw new Error('Supabase client not available');
    }

    // Initialize Supabase
    const supabase = window.supabase.createClient(
      'https://zvlhklttjjddauidtjas.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2bGhrbHR0ampkZGF1aWR0amFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgzMjIxMTYsImV4cCI6MjA2Mzg5ODExNn0.XF1eNZo_DwskyKo-mmB_ivx7GTcugAaFEugdPmou-lw'
    );

    // LocalStorage Helper Functions
    const getLocalStorageData = (key) => {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : [];
      } catch (err) {
        console.error(`Error reading ${key} from localStorage:`, err.message);
        return [];
      }
    };

    const setLocalStorageData = (key, data) => {
      try {
        localStorage.setItem(key, JSON.stringify(data));
      } catch (err) {
        console.error(`Error writing to ${key} in localStorage:`, err.message);
        throw err;
      }
    };

    // Supabase-based storageRequest function
    const storageRequest = async (endpoint, method = 'GET', data = null) => {
      try {
        if (method === 'GET') {
          const { data: result, error } = await supabase
            .from(endpoint)
            .select('*');
          if (error) {
            console.error(`Supabase GET error for ${endpoint}:`, error);
            throw new Error(`Failed to fetch from ${endpoint}: ${error.message} (Code: ${error.code})`);
          }
          return result || [];
        } else if (method === 'POST') {
          const { data: result, error } = await supabase
            .from(endpoint)
            .insert(Array.isArray(data) ? data : [data])
            .select();
          if (error) {
            console.error(`Supabase POST error for ${endpoint}:`, error);
            throw new Error(`Failed to insert into ${endpoint}: ${error.message} (Code: ${error.code})`);
          }
          return result || [];
        } else if (method === 'DELETE') {
          const idToDelete = endpoint.split('/')[1];
          const { data: result, error } = await supabase
            .from(endpoint.split('/')[0])
            .delete()
            .eq('id', idToDelete)
            .select();
          if (error) {
            console.error(`Supabase DELETE error for ${endpoint}:`, error);
            throw new Error(`Failed to delete from ${endpoint}: ${error.message} (Code: ${error.code})`);
          }
          return result || [];
        } else if (method === 'CLEAR') {
          const { data: result, error } = await supabase
            .from(endpoint)
            .delete()
            .neq('id', 'non-existent-id');
          if (error) {
            console.error(`Supabase CLEAR error for ${endpoint}:`, error);
            throw new Error(`Failed to clear ${endpoint}: ${error.message} (Code: ${error.code})`);
          }
          return result || [];
        }
      } catch (err) {
        console.error(`Error in storageRequest (${endpoint}, ${method}):`, err);
        if (method === 'GET') {
          console.warn(`Falling back to localStorage for ${endpoint}. Check Supabase error above.`);
          return getLocalStorageData(endpoint);
        } else if (method === 'POST') {
          console.warn(`Falling back to localStorage for ${endpoint}. Check Supabase error above.`);
          const currentData = getLocalStorageData(endpoint);
          const updatedData = Array.isArray(data) ? [...currentData, ...data] : [...currentData, data];
          setLocalStorageData(endpoint, updatedData);
          return data;
        } else if (method === 'DELETE') {
          console.warn(`Falling back to localStorage for ${endpoint}. Check Supabase error above.`);
          const currentData = getLocalStorageData(endpoint.split('/')[0]);
          const updatedData = currentData.filter(item => item.id !== idToDelete);
          setLocalStorageData(endpoint.split('/')[0], updatedData);
          return [{ id: idToDelete }];
        } else if (method === 'CLEAR') {
          console.warn(`Falling back to localStorage for ${endpoint}. Check Supabase error above.`);
          setLocalStorageData(endpoint, []);
          return [];
        }
        throw err;
      }
    };

    // Initialize Supabase tables with demo data
    const initializeStorage = async () => {
      try {
        await storageRequest('Users', 'CLEAR');
        const demoUsers = [
          { id: 'user-1', email: 'admin@admin.com', password: 'admin123', role: 'admin' },
          { id: 'user-2', email: 'aswathi@demo.com', password: 'user123', role: 'user' }
        ];
        await storageRequest('Users', 'POST', demoUsers);
        const users = await storageRequest('Users');
        if (!users || users.length === 0) {
          console.warn('Supabase returned no users. Falling back to localStorage.');
          setLocalStorageData('Users', demoUsers);
        }

        await storageRequest('Groups', 'CLEAR');
        await storageRequest('TestCases', 'CLEAR');
        await storageRequest('Reports', 'CLEAR');
      } catch (err) {
        console.error('Failed to initialize Supabase data:', err);
        const demoUsers = [
          { id: 'user-1', email: 'admin@admin.com', password: 'admin123', role: 'admin' },
          { id: 'user-2', email: 'aswathi@demo.com', password: 'user123', role: 'user' }
        ];
        setLocalStorageData('Users', demoUsers);
        setLocalStorageData('Groups', []);
        setLocalStorageData('TestCases', []);
        setLocalStorageData('Reports', []);
        console.warn('Initialized localStorage with demo data due to Supabase failure.');
      }
    };

    const generateUUID = () => {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
        const r = (Math.random() * 16) | 0;
        const v = c === 'x' ? r : (r & 0x3) | 0x8;
        return v.toString(16);
      });
    };

    const qaTips = [
      "Automation Tip: Use Selenium WebDriver for cross-browser testing to catch UI bugs early.",
      "Efficiency Tip: Prioritize test cases by risk impact to maximize QA coverage.",
      "Best Practice: Write clear, atomic test steps to reduce ambiguity.",
      "Automation Tip: Integrate API testing with Postman to validate backend logic.",
      "Efficiency Tip: Use pairwise testing to reduce test case volume while maintaining coverage.",
      "Best Practice: Document edge cases to ensure robust test scenarios.",
      "Automation Tip: Leverage Cypress for fast, reliable end-to-end testing.",
      "Efficiency Tip: Conduct daily stand-ups to align QA with dev progress."
    ];

    const PHASES = [
      { value: 'HTML Comparison', label: 'HTML Comparison' },
      { value: 'After Live', label: 'After Live' },
      { value: 'Dev Test', label: 'Dev Test' },
      { value: 'Dev ReTest', label: 'Dev ReTest' },
      { value: 'Before Live', label: 'Before Live' }
    ];

    function FlashTicker() {
      return React.createElement(
        'div',
        { className: 'bg-blue-900 text-white py-2 overflow-hidden' },
        React.createElement(
          'div',
          { className: 'marquee' },
          qaTips.map((tip, idx) =>
            React.createElement('span', { key: idx, className: 'mx-4' }, tip)
          )
        )
      );
    }

    function ErrorBoundary({ children }) {
      const [hasError, setHasError] = useState(false);

      useEffect(() => {
        const handleError = (error, errorInfo) => {
          console.error('ErrorBoundary caught an error:', error, errorInfo);
          setHasError(true);
        };
        window.addEventListener('error', handleError);
        window.addEventListener('unhandledrejection', (event) => {
          console.error('Unhandled promise rejection:', event.reason);
          setHasError(true);
        });
        return () => {
          window.removeEventListener('error', handleError);
          window.removeEventListener('unhandledrejection', handleError);
        };
      }, []);

      if (hasError) {
        return React.createElement(
          'div',
          { className: 'p-6 text-red-500' },
          'Something went wrong. Please refresh the page and check the console for details.'
        );
      }
      return children;
    }

    function App() {
      const [user, setUser] = useState(null);
      const [role, setRole] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState('');

      useEffect(() => {
        const loadData = async () => {
          try {
            await initializeStorage();
            const storedUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (storedUser.email) {
              setUser(storedUser);
              setRole(storedUser.role);
            }
          } catch (err) {
            setError('Failed to initialize storage. Demo users available in localStorage.');
            console.error('Failed to load data in App:', err);
          } finally {
            setLoading(false);
          }
        };
        loadData();
      }, []);

      if (loading) {
        return React.createElement(
          'div',
          { className: 'flex items-center justify-center h-screen text-blue-600' },
          'Loading...'
        );
      }

      if (error) {
        return React.createElement(
          'div',
          { className: 'flex items-center justify-center h-screen text-red-500' },
          error
        );
      }

      return React.createElement(
        ErrorBoundary,
        null,
        React.createElement(
          'div',
          { className: 'min-h-screen' },
          React.createElement(FlashTicker),
          !user
            ? React.createElement(Login, { setUser, setRole })
            : role === 'admin'
            ? React.createElement(AdminDashboard, { user })
            : React.createElement(UserDashboard, { user })
        )
      );
    }

    function Login({ setUser, setRole }) {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loginMode, setLoginMode] = useState('user');

      const handleLogin = async (e) => {
        e.preventDefault();
        setError('');
        try {
          const users = await storageRequest('Users');
          if (!users || users.length === 0) {
            setError('No users found. Demo users initialized. Check console.');
            return;
          }
          const foundUser = users.find(u => u.email === email && u.password === password);
          if (foundUser) {
            if ((loginMode === 'admin' && foundUser.role === 'admin') || (loginMode === 'user' && foundUser.role === 'user')) {
              localStorage.setItem('currentUser', JSON.stringify(foundUser));
              setUser(foundUser);
              setRole(foundUser.role);
            } else {
              setError(`Role mismatch: Selected "${loginMode}" login, but user is a "${foundUser.role}".`);
            }
          } else {
            setError('Invalid email or password. Use admin@admin.com/admin123 for Admin, or aswathi@demo.com/user123 for User.');
          }
        } catch (err) {
          setError(`Failed to process login: ${err.message}. Demo users in localStorage.`);
          console.error('Login error:', err);
        }
      };

      const handleResetStorage = async () => {
        setError('');
        try {
          localStorage.removeItem('currentUser');
          localStorage.removeItem('userSession');
          localStorage.removeItem('Users');
          await initializeStorage();
          setError('Session cleared and demo users re-initialized. Try logging in.');
        } catch (err) {
          setError('Failed to reset session data. Check console.');
          console.error('Reset session error:', err);
        }
      };

      return React.createElement(
        'div',
        { className: 'flex items-center justify-center h-screen bg-gray-100' },
        React.createElement(
          'div',
          { className: 'bg-white p-8 rounded-lg custom-shadow w-96' },
          React.createElement('h2', { className: 'text-xl font-semibold mb-2 text-center text-gray-800' }, 'Test Case Manager'),
          React.createElement('p', { className: 'text-sm text-gray-600 mb-6 text-center' }, 'Login to access the test case management system'),
          error && React.createElement('p', { className: 'text-red-500 mb-4 text-center' }, error),
          React.createElement(
            'div',
            { className: 'flex mb-6' },
            React.createElement(
              'button',
              {
                onClick: () => setLoginMode('user'),
                className: `flex-1 py-2 font-medium ${loginMode === 'user' ? 'tab-active' : 'tab-inactive'}`
              },
              'User Login'
            ),
            React.createElement(
              'button',
              {
                onClick: () => setLoginMode('admin'),
                className: `flex-1 py-2 font-medium ${loginMode === 'admin' ? 'tab-active' : 'tab-inactive'}`
              },
              'Admin Login'
            )
          ),
          React.createElement(
            'div',
            null,
            React.createElement('label', { className: 'block text-sm text-gray-600 mb-2' }, 'Email'),
            React.createElement('input', {
              type: 'email',
              placeholder: 'Enter your email',
              value: email,
              onChange: (e) => setEmail(e.target.value),
              className: 'w-full p-3 mb-4 border rounded-lg input-focus'
            }),
            React.createElement('label', { className: 'block text-sm text-gray-600 mb-2' }, 'Password'),
            React.createElement('input', {
              type: 'password',
              placeholder: 'Enter your password',
              value: password,
              onChange: (e) => setPassword(e.target.value),
              className: 'w-full p-3 mb-6 border rounded-lg input-focus'
            }),
            React.createElement(
              'button',
              {
                onClick: handleLogin,
                className: 'w-full bg-blue-900 text-white p-3 rounded-lg hover:bg-blue-800 transition'
              },
              `Login as ${loginMode.charAt(0).toUpperCase() + loginMode.slice(1)}`
            ),
            React.createElement(
              'p',
              { className: 'text-sm text-gray-500 mt-4 text-center' },
              'Demo credentials: admin@admin.com/admin123 (Admin) or aswathi@demo.com/user123 (User)'
            )
          ),
          React.createElement(
            'button',
            {
              onClick: handleResetStorage,
              className: 'w-full bg-gray-500 text-white p-3 mt-4 rounded-lg hover:bg-gray-600 transition'
            },
            'Reset Session'
          )
        )
      );
    }

    function AdminDashboard({ user }) {
      const [activeTab, setActiveTab] = useState('dashboard');

      const handleLogout = () => {
        localStorage.removeItem('currentUser');
        localStorage.removeItem('userSession');
        window.location.reload();
      };

      return React.createElement(
        'div',
        { className: 'flex min-h-screen' },
        React.createElement(
          'div',
          { className: 'w-64 bg-white p-6 shadow-sm' },
          React.createElement('h2', { className: 'text-xl font-semibold mb-6 text-gray-800' }, 'TestCase Manager'),
          React.createElement(
            'nav',
            null,
            React.createElement(
              'button',
              {
                onClick: () => setActiveTab('dashboard'),
                className: `w-full text-left px-4 py-3 rounded-lg sidebar-item mb-2 flex items-center ${activeTab === 'dashboard' ? 'bg-gray-100 text-gray-800' : 'text-gray-600'}`
              },
              React.createElement('svg', { className: 'w-5 h-5 mr-2', fill: 'currentColor', viewBox: '0 0 20 20' }, React.createElement('path', { d: 'M10 2L2 6v12h16V6l-8-4zm0 2.828l5.172 2.586V16H4.828V7.414L10 4.828z' })),
              'Dashboard'
            ),
            React.createElement(
              'button',
              {
                onClick: () => setActiveTab('groups'),
                className: `w-full text-left px-4 py-3 rounded-lg sidebar-item mb-2 flex items-center ${activeTab === 'groups' ? 'bg-gray-100 text-gray-800' : 'text-gray-600'}`
              },
              React.createElement('svg', { className: 'w-5 h-5 mr-2', fill: 'currentColor', viewBox: '0 0 20 20' }, React.createElement('path', { d: 'M4 4h12v12H4V4zm2 2v8h8V6H6z' })),
              'Manage Groups'
            ),
            React.createElement(
              'button',
              {
                onClick: () => setActiveTab('testcases'),
                className: `w-full text-left px-4 py-3 rounded-lg sidebar-item mb-2 flex items-center ${activeTab === 'testcases' ? 'bg-gray-100 text-gray-800' : 'text-gray-600'}`
              },
              React.createElement('svg', { className: 'w-5 h-5 mr-2', fill: 'currentColor', viewBox: '0 0 20 20' }, React.createElement('path', { d: 'M2 3h16v14H2V3zm4 8h2v4H6v-4zm4-4h2v8h-2V7zm4 2h2v6h-2V9z' })),
              'Manage Test Cases'
            ),
            React.createElement(
              'button',
              {
                onClick: () => setActiveTab('reports'),
                className: `w-full text-left px-4 py-3 rounded-lg sidebar-item mb-2 flex items-center ${activeTab === 'reports' ? 'bg-gray-100 text-gray-800' : 'text-gray-600'}`
              },
              React.createElement('svg', { className: 'w-5 h-5 mr-2', fill: 'currentColor', viewBox: '0 0 20 20' }, React.createElement('path', { d: 'M2 3h16v14H2V3zm4 8h2v4H6v-4zm4-4h2v8h-2V7zm4 2h2v6h-2V9z' })),
              'View Reports'
            )
          )
        ),
        React.createElement(
          'div',
          { className: 'flex-1 p-8' },
          React.createElement(
            'div',
            { className: 'flex justify-between items-center mb-6' },
            React.createElement('h1', { className: 'text-2xl font-bold text-gray-800' }, 'Test Case Management System'),
            React.createElement(
              'div',
              { className: 'flex items-center space-x-3' },
              React.createElement(
                'div',
                { className: 'flex items-center space-x-2' },
                React.createElement(
                  'div',
                  { className: 'w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center' },
                  React.createElement('svg', { className: 'w-5 h-5 text-gray-600', fill: 'currentColor', viewBox: '0 0 20 20' }, React.createElement('path', { d: 'M10 10a4 4 0 100-8 4 4 0 000 8zm0 2a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6z' }))
                ),
                React.createElement('span', { className: 'text-gray-700' }, user.role)
              ),
              React.createElement(
                'button',
                {
                  onClick: handleLogout,
                  className: 'text-gray-600 hover:text-gray-800 flex items-center'
                },
                React.createElement('svg', { className: 'w-5 h-5 mr-1', fill: 'currentColor', viewBox: '0 0 20 20' }, React.createElement('path', { d: 'M3 3h14v14H3V3zm10 6h4v2h-4v4l-4-4 4-4v4z' })),
                'Logout'
              )
            )
          ),
          activeTab === 'dashboard' && React.createElement(AdminSummary),
          activeTab === 'groups' && React.createElement(ManageGroups),
          activeTab === 'testcases' && React.createElement(ManageTestCases),
          activeTab === 'reports' && React.createElement(ViewReports)
        )
      );
    }

    function AdminSummary() {
      const [groups, setGroups] = useState([]);
      const [testCases, setTestCases] = useState([]);
      const [reports, setReports] = useState([]);
      const [error, setError] = useState('');

      useEffect(() => {
        const fetchData = async () => {
          try {
            const fetchedGroups = await storageRequest('Groups');
            const fetchedTestCases = await storageRequest('TestCases');
            const fetchedReports = await storageRequest('Reports');
            setGroups(fetchedGroups || []);
            setTestCases(fetchedTestCases || []);
            setReports(fetchedReports || []);
          } catch (err) {
            setError('Failed to load summary data. Check console.');
            console.error('Failed to load data in AdminSummary:', err);
          }
        };
        fetchData();
      }, []);

      const completedCount = reports.reduce((sum, report) => sum + (Number(report.completedCount) || 0), 0);
      const pendingCount = reports.reduce((sum, report) => sum + (Number(report.pendingCount) || 0), 0);
      const total = completedCount + pendingCount;
      const completionRate = total > 0 ? Math.round((completedCount / total) * 100) : 0;

      return React.createElement(
        'div',
        null,
        React.createElement('h2', { className: 'text-xl font-bold mb-4 text-gray-800' }, 'Admin Dashboard'),
        error && React.createElement('p', { className: 'text-red-500 mb-4' }, error),
        React.createElement('p', { className: 'text-gray-600 mb-6' }, 'Manage test groups, test cases, and view reports.'),
        React.createElement(
          'div',
          { className: 'grid grid-cols-1 md:grid-cols-2 gap-6 mb-6' },
          React.createElement(
            'div',
            { className: 'bg-white p-6 rounded-lg custom-shadow' },
            React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-4' }, 'Overall Test Completion'),
            React.createElement('p', { className: 'text-4xl font-bold text-gray-800' }, completionRate, '%'),
            React.createElement('p', { className: 'text-gray-600 mt-2' }, 'Completion Rate'),
            React.createElement(
              'div',
              { className: 'flex mt-4 space-x-4' },
              React.createElement(
                'div',
                { className: 'flex items-center' },
                React.createElement('span', { className: 'w-4 h-4 bg-green-500 rounded-full mr-2' }),
                React.createElement('span', { className: 'text-gray-600' }, 'Completed')
              ),
              React.createElement(
                'div',
                { className: 'flex items-center' },
                React.createElement('span', { className: 'w-4 h-4 bg-yellow-500 rounded-full mr-2' }),
                React.createElement('span', { className: 'text-gray-600' }, 'Pending')
              )
            )
          ),
          React.createElement(
            'div',
            { className: 'bg-white p-6 rounded-lg custom-shadow' },
            React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-4' }, 'Summary'),
            React.createElement('p', { className: 'text-gray-600' }, 'Total Reports: ', React.createElement('span', { className: 'font-semibold' }, reports.length)),
            React.createElement('p', { className: 'text-gray-600' }, 'Total Test Cases: ', React.createElement('span', { className: 'font-semibold' }, testCases.length)),
            React.createElement('p', { className: 'text-gray-600' }, 'Total Groups: ', React.createElement('span', { className: 'font-semibold' }, groups.length))
          )
        ),
        React.createElement(
          'div',
          { className: 'bg-white p-6 rounded-lg custom-shadow' },
          React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-4' }, 'Recent Reports'),
          reports.length > 0
            ? reports.slice(0, 3).map(report =>
                React.createElement(
                  'div',
                  { key: report.id, className: 'mt-4 p-4 bg-gray-50 rounded-lg' },
                  React.createElement('p', { className: 'text-gray-800' }, 'User: ', report.userName || 'Unknown'),
                  React.createElement('p', { className: 'text-gray-600' }, 'Project: ', report.projectName || 'N/A', ', Phase: ', report.phase || 'N/A'),
                  React.createElement('p', { className: 'text-gray-600' }, 'Completed: ', report.completedCount || 0, ', Pending: ', report.pendingCount || 0)
                )
              )
            : React.createElement('p', { className: 'text-gray-600' }, 'No reports available yet.')
        )
      );
    }

    function ManageGroups() {
      const [groups, setGroups] = useState([]);
      const [showPopup, setShowPopup] = useState(false);
      const [groupName, setGroupName] = useState('');
      const [description, setDescription] = useState('');
      const [phase, setPhase] = useState('');
      const [error, setError] = useState('');

      useEffect(() => {
        const fetchGroups = async () => {
          try {
            const storedGroups = await storageRequest('Groups');
            setGroups(storedGroups || []);
          } catch (err) {
            setError('Failed to load groups. Check console.');
            console.error('Error in ManageGroups:', err);
          }
        };
        fetchGroups();
      }, []);

      const handleCreateGroup = async () => {
        if (!groupName || !phase) {
          setError('Group name and phase are required');
          return;
        }
        try {
          const newGroup = { 
            id: generateUUID(), 
            name: groupName, 
            description: description || null, 
            phase 
          };
          await storageRequest('Groups', 'POST', [newGroup]);
          const updatedGroups = await storageRequest('Groups');
          setGroups(updatedGroups || []);
          setGroupName('');
          setDescription('');
          setPhase('');
          setShowPopup(false);
          setError('');
        } catch (err) {
          setError(`Failed to create group: ${err.message}. Check console.`);
          console.error('Error in handleCreateGroup:', err);
        }
      };

      return React.createElement(
        'div',
        null,
        React.createElement('h2', { className: 'text-xl font-bold mb-4 text-gray-800' }, 'Test Groups'),
        error && React.createElement('p', { className: 'text-red-500 mb-4' }, error),
        React.createElement(
          'button',
          {
            onClick: () => setShowPopup(true),
            className: 'bg-blue-900 text-white px-4 py-2 rounded-lg hover:bg-blue-800 transition mb-6 flex items-center'
          },
          React.createElement('svg', { className: 'w-5 h-5 mr-2', fill: 'currentColor', viewBox: '0 0 20 20' }, React.createElement('path', { d: 'M10 3v14m-7-7h14' })),
          'Create Group'
        ),
        groups.length > 0
          ? React.createElement(
              'div',
              { className: 'space-y-4' },
              groups.map(group =>
                React.createElement(
                  'div',
                  { key: group.id, className: 'bg-white p-4 rounded-lg custom-shadow card-hover' },
                  React.createElement('h3', { className: 'font-semibold text-gray-800' }, group.name),
                  React.createElement('p', { className: 'text-gray-600' }, 'Description: ', group.description || 'None'),
                  React.createElement('p', { className: 'text-gray-600' }, 'Phase: ', group.phase)
                )
              )
            )
          : React.createElement('p', { className: 'text-gray-600' }, 'No groups have been created yet. Click "Create Group" to add one.'),
        showPopup &&
          React.createElement(
            'div',
            { className: 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50' },
            React.createElement(
              'div',
              { className: 'bg-white p-6 rounded-lg custom-shadow w-96' },
              React.createElement(
                'div',
                { className: 'flex justify-between items-center mb-4' },
                React.createElement('h3', { className: 'text-lg font-semibold text-gray-800' }, 'Create New Group'),
                React.createElement(
                  'button',
                  { onClick: () => setShowPopup(false), className: 'text-gray-600 hover:text-gray-800' },
                  React.createElement('svg', { className: 'w-5 h-5', fill: 'currentColor', viewBox: '0 0 20 20' }, React.createElement('path', { d: 'M6 6l8 8m0-8l-8 8' }))
                )
              ),
              React.createElement('p', { className: 'text-gray-600 mb-4' }, 'Fill the details to create a new test group.'),
              React.createElement('label', { className: 'block text-sm text-gray-600 mb-2' }, 'Group Name'),
              React.createElement('input', {
                type: 'text',
                placeholder: 'Enter group name',
                value: groupName,
                onChange: (e) => setGroupName(e.target.value),
                className: 'w-full p-3 border rounded-lg input-focus mb-4'
              }),
              React.createElement('label', { className: 'block text-sm text-gray-600 mb-2' }, 'Description'),
              React.createElement('textarea', {
                placeholder: 'Enter group description',
                value: description,
                onChange: (e) => setDescription(e.target.value),
                className: 'w-full p-3 border rounded-lg input-focus mb-4 h-24'
              }),
              React.createElement('label', { className: 'block text-sm text-gray-600 mb-2' }, 'Phase'),
              React.createElement(
                'select',
                {
                  value: phase,
                  onChange: (e) => setPhase(e.target.value),
                  className: 'w-full p-3 border rounded-lg input-focus mb-4'
                },
                React.createElement('option', { value: '' }, 'Select a phase'),
                PHASES.map(phaseOption =>
                  React.createElement('option', { key: phaseOption.value, value: phaseOption.value }, phaseOption.label)
                )
              ),
              React.createElement(
                'button',
                {
                  onClick: handleCreateGroup,
                  className: 'w-full bg-blue-900 text-white p-3 rounded-lg hover:bg-blue-800 transition'
                },
                'Create Group'
              )
            )
          )
      );
    }

    function ManageTestCases() {
      const [testCases, setTestCases] = useState([]);
      const [groups, setGroups] = useState([]);
      const [title, setTitle] = useState('');
      const [steps, setSteps] = useState('');
      const [selectedGroup, setSelectedGroup] = useState('');
      const [error, setError] = useState('');

      useEffect(() => {
        const fetchData = async () => {
          try {
            const storedTestCases = await storageRequest('TestCases');
            const storedGroups = await storageRequest('Groups');
            setTestCases(storedTestCases || []);
            setGroups(storedGroups || []);
          } catch (err) {
            setError('Failed to load test cases or groups. Check console.');
            console.error('Error in ManageTestCases:', err);
          }
        };
        fetchData();
      }, []);

      const handleCreateTestCase = async () => {
        if (!title || !steps || !selectedGroup) {
          setError('All fields are required');
          return;
        }
        try {
          const newTestCase = {
            id: generateUUID(),
            title,
            steps: steps.split('\n').filter(step => step.trim()).join('\n'),
            groupId: selectedGroup,
            createdAt: new Date().toISOString()
          };
          await storageRequest('TestCases', 'POST', [newTestCase]);
          const updatedTestCases = await storageRequest('TestCases');
          setTestCases(updatedTestCases || []);
          setTitle('');
          setSteps('');
          setSelectedGroup('');
          setError('');
        } catch (err) {
          setError(`Failed to create test case: ${err.message}. Check console.`);
          console.error('Error in handleCreateTestCase:', err);
        }
      };

      const handleDuplicate = async (testCase) => {
        try {
          const newTestCase = { ...testCase, id: generateUUID(), createdAt: new Date().toISOString() };
          await storageRequest('TestCases', 'POST', [newTestCase]);
          const updatedTestCases = await storageRequest('TestCases');
          setTestCases(updatedTestCases || []);
          setError('');
        } catch (err) {
          setError(`Failed to duplicate test case: ${err.message}. Check console.`);
          console.error('Error in handleDuplicate:', err);
        }
      };

      const handleDelete = async (id) => {
        try {
          await storageRequest(`TestCases/${id}`, 'DELETE');
          const updatedTestCases = await storageRequest('TestCases');
          setTestCases(updatedTestCases || []);
          setError('');
        } catch (err) {
          setError(`Failed to delete test case: ${err.message}. Check console.`);
          console.error('Error in handleDelete:', err);
        }
      };

      return React.createElement(
        'div',
        null,
        React.createElement('h2', { className: 'text-xl font-bold mb-4 text-gray-800' }, 'Manage Test Cases'),
        error && React.createElement('p', { className: 'text-red-500 mb-4' }, error),
        React.createElement(
          'div',
          { className: 'bg-white p-6 rounded-lg custom-shadow mb-6' },
          React.createElement(
            'div',
            { className: 'space-y-4' },
            React.createElement(
              'div',
              null,
              React.createElement('label', { className: 'block text-sm text-gray-600 mb-2' }, 'Test Case Title'),
              React.createElement('input', {
                type: 'text',
                placeholder: 'Enter test case title',
                value: title,
                onChange: (e) => setTitle(e.target.value),
                className: 'w-full p-3 border rounded-lg input-focus'
              })
            ),
            React.createElement(
              'div',
              null,
              React.createElement('label', { className: 'block text-sm text-gray-600 mb-2' }, 'Test Steps'),
              React.createElement('textarea', {
                placeholder: 'Enter test steps (one per line)',
                value: steps,
                onChange: (e) => setSteps(e.target.value),
                className: 'w-full p-3 border rounded-lg input-focus h-32'
              })
            ),
            React.createElement(
              'div',
              null,
              React.createElement('label', { className: 'block text-sm text-gray-600 mb-2' }, 'Select Group'),
              React.createElement(
                'select',
                {
                  value: selectedGroup,
                  onChange: (e) => setSelectedGroup(e.target.value),
                  className: 'w-full p-3 border rounded-lg input-focus'
                },
                React.createElement('option', { value: '' }, 'Select a group'),
                groups.map(group =>
                  React.createElement('option', { key: group.id, value: group.id }, group.name)
                )
              )
            ),
            React.createElement(
              'button',
              {
                onClick: handleCreateTestCase,
                className: 'w-full bg-blue-900 text-white p-3 rounded-lg hover:bg-blue-800 transition'
              },
              'Create Test Case'
            )
          )
        ),
        testCases.length > 0
          ? React.createElement(
              'div',
              { className: 'space-y-4' },
              testCases.map(tc =>
                React.createElement(
                  'div',
                  { key: tc.id, className: 'bg-white p-6 rounded-lg custom-shadow card-hover' },
                  React.createElement(
                    'div',
                    { className: 'flex justify-between items-start' },
                    React.createElement(
                      'div',
                      null,
                      React.createElement('h3', { className: 'font-semibold text-gray-800' }, tc.title),
                      React.createElement('p', { className: 'text-gray-600' }, 'Group: ', groups.find(g => g.id === tc.groupId)?.name || 'Unknown'),
                      React.createElement(
                        'ul',
                        { className: 'ml-4 list-disc text-gray-700' },
                        tc.steps.split('\n').map((step, idx) =>
                          React.createElement('li', { key: idx }, step)
                        )
                      )
                    ),
                    React.createElement(
                      'div',
                      { className: 'flex space-x-2' },
                      React.createElement(
                        'button',
                        {
                          onClick: () => handleDuplicate(tc),
                          className: 'bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600'
                        },
                        'Duplicate'
                      ),
                      React.createElement(
                        'button',
                        {
                          onClick: () => handleDelete(tc.id),
                          className: 'bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600'
                        },
                        'Delete'
                      )
                    )
                  )
                )
              )
            )
          : React.createElement('p', { className: 'text-gray-600' }, 'No test cases have been created yet. Use the form above to add one.')
      );
    }

    function ViewReports() {
      const [reports, setReports] = useState([]);
      const [error, setError] = useState('');
      const [selectedReport, setSelectedReport] = useState(null);
      const [completedTestCases, setCompletedTestCases] = useState([]);
      const [testCases, setTestCases] = useState([]);
      const chartRef = useRef(null);

      useEffect(() => {
        const fetchReports = async () => {
          try {
            const storedReports = await storageRequest('Reports');
            const storedTestCases = await storageRequest('TestCases');
            setReports(storedReports || []);
            setTestCases(storedTestCases || []);
          } catch (err) {
            setError('Failed to load reports or test cases. Check console.');
            console.error('Error in ViewReports:', err);
          }
        };
        fetchReports();
      }, []);

      useEffect(() => {
        if (!selectedReport) return;

        const canvas = document.getElementById(`adminReportChart-${selectedReport.id}`);
        if (!canvas) {
          setError('Chart canvas element not found');
          console.error('Chart canvas not found for admin report');
          return;
        }

        const ctx = canvas.getContext('2d');
        if (!ctx) {
          setError('Failed to get 2D context for chart');
          console.error('Failed to get 2D context for admin report chart');
          return;
        }

        if (!Chart) {
          setError('Chart.js library failed to load');
          console.error('Chart.js not available');
          return;
        }

        // Destroy previous chart instance if it exists
        if (chartRef.current) {
          chartRef.current.destroy();
        }

        try {
          chartRef.current = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: ['Test Cases'],
              datasets: [
                {
                  label: 'Completed',
                  data: [Number(selectedReport.completedCount) || 0],
                  backgroundColor: '#10b981',
                },
                {
                  label: 'Pending',
                  data: [Number(selectedReport.pendingCount) || 0],
                  backgroundColor: '#f59e0b',
                }
              ]
            },
            options: {
              scales: {
                y: { beginAtZero: true }
              },
              responsive: true,
              maintainAspectRatio: false
            }
          });

          // Calculate completed test cases
          const groupTestCases = testCases.filter(tc => tc.groupId === selectedReport.groupId);
          const pendingTitles = selectedReport.pendingTestCases ? selectedReport.pendingTestCases.split(', ') : [];
          const completed = groupTestCases
            .filter(tc => !pendingTitles.includes(tc.title))
            .map(tc => tc.title);
          setCompletedTestCases(completed);
        } catch (err) {
          setError('Failed to render report chart. Check console.');
          console.error('Error rendering admin report chart:', err);
        }

        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
            chartRef.current = null;
          }
        };
      }, [selectedReport, testCases]);

      const handleReportClick = async (report) => {
        try {
          const group = (await storageRequest('Groups')).find(g => g.phase === report.phase);
          const reportWithGroup = { ...report, groupId: group?.id || null };
          setSelectedReport(reportWithGroup);
        } catch (err) {
          setError('Failed to load group for report. Check console.');
          console.error('Error in handleReportClick:', err);
        }
      };

      return React.createElement(
        'div',
        null,
        React.createElement('h2', { className: 'text-xl font-bold mb-4 text-gray-800' }, 'View Reports'),
        error && React.createElement('p', { className: 'text-red-500 mb-4' }, error),
        reports.length > 0
          ? React.createElement(
              'div',
              { className: 'space-y-4' },
              reports.map(report =>
                React.createElement(
                  'div',
                  {
                    key: report.id,
                    className: 'bg-white p-6 rounded-lg custom-shadow card-hover cursor-pointer',
                    onClick: () => handleReportClick(report)
                  },
                  React.createElement('h3', { className: 'font-semibold text-gray-800' }, report.userName || 'Unknown'),
                  React.createElement('p', { className: 'text-gray-600' }, 'Project: ', report.projectName || 'N/A', ', Phase: ', report.phase || 'N/A'),
                  React.createElement('p', { className: 'text-gray-600' }, 'Completed: ', report.completedCount || 0, ', Pending: ', report.pendingCount || 0),
                  React.createElement('p', { className: 'text-gray-600' }, 'Time Spent: ', Math.floor(report.timeSpent / 60) || 0, 'm ', report.timeSpent % 60 || 0, 's')
                )
              )
            )
          : React.createElement('p', { className: 'text-gray-600 mb-6' }, 'No reports available yet. Users need to complete test executions.'),
        selectedReport &&
          React.createElement(
            'div',
            { className: 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50' },
            React.createElement(
              'div',
              { className: 'bg-white p-6 rounded-lg custom-shadow w-full max-w-lg' },
              React.createElement(
                'div',
                { className: 'modal-scroll' },
                React.createElement(
                  'div',
                  { className: 'flex justify-between items-center mb-4' },
                  React.createElement('h3', { className: 'text-lg font-semibold text-gray-800' }, 'Report Details'),
                  React.createElement(
                    'button',
                    { onClick: () => setSelectedReport(null), className: 'text-gray-600 hover:text-gray-800 p-2 rounded-full hover:bg-gray-100 transition' },
                    React.createElement('svg', { className: 'w-6 h-6', fill: 'currentColor', viewBox: '0 0 20 20' }, React.createElement('path', { d: 'M6 6l8 8m0-8l-8 8' }))
                  )
                ),
                React.createElement('p', { className: 'text-gray-600 mb-4' }, 'Project: ', selectedReport.projectName, ', Phase: ', selectedReport.phase),
                React.createElement(
                  'div',
                  { className: 'chart-container mb-6' },
                  React.createElement('canvas', { id: `adminReportChart-${selectedReport.id}` })
                ),
                React.createElement(
                  'div',
                  { className: 'space-y-2 mb-4' },
                  React.createElement('p', { className: 'text-gray-600' }, 'Total Test Cases: ', React.createElement('span', { className: 'font-semibold' }, (Number(selectedReport.completedCount) || 0) + (Number(selectedReport.pendingCount) || 0))),
                  React.createElement('p', { className: 'text-gray-600' }, 'Completed: ', React.createElement('span', { className: 'font-semibold text-green-600' }, selectedReport.completedCount)),
                  React.createElement('p', { className: 'text-gray-600' }, 'Pending: ', React.createElement('span', { className: 'font-semibold text-yellow-600' }, selectedReport.pendingCount)),
                  React.createElement('p', { className: 'text-gray-600' }, 'Time Spent: ', React.createElement('span', { className: 'font-semibold' }, Math.floor(selectedReport.timeSpent / 60), 'm ', selectedReport.timeSpent % 60, 's'))
                ),
                React.createElement('h4', { className: 'font-semibold text-gray-800 mb-2' }, 'Completed Test Cases:'),
                completedTestCases.length > 0
                  ? React.createElement(
                      'ul',
                      { className: 'ml-4 list-disc text-gray-700 mb-4' },
                      completedTestCases.map((title, idx) =>
                        React.createElement('li', { key: idx }, title)
                      )
                    )
                  : React.createElement('p', { className: 'text-gray-600 mb-4' }, 'None'),
                React.createElement('h4', { className: 'font-semibold text-gray-800 mb-2' }, 'Pending Test Cases:'),
                selectedReport.pendingTestCases
                  ? React.createElement(
                      'ul',
                      { className: 'ml-4 list-disc text-gray-700' },
                      selectedReport.pendingTestCases.split(', ').map((title, idx) =>
                        React.createElement('li', { key: idx }, title)
                      )
                    )
                  : React.createElement('p', { className: 'text-gray-600' }, 'None')
              )
            )
          )
      );
    }

    function UserDashboard({ user }) {
      const [activeTab, setActiveTab] = useState('dashboard');
      const [showPopup, setShowPopup] = useState(true);
      const [showReport, setShowReport] = useState(false);
      const [userName, setUserName] = useState('');
      const [projectName, setProjectName] = useState('');
      const [phase, setPhase] = useState('');
      const [groups, setGroups] = useState([]);
      const [selectedGroup, setSelectedGroup] = useState(null);
      const [testCases, setTestCases] = useState([]);
      const [timer, setTimer] = useState(0);
      const [isRunning, setIsRunning] = useState(false);
      const [completed, setCompleted] = useState({});
      const [error, setError] = useState('');
      const [reportData, setReportData] = useState(null);
      const chartRef = useRef(null);

      // Dashboard overview state
      const [userReports, setUserReports] = useState([]);
      const dashboardChartRef = useRef(null);

      useEffect(() => {
        // Fetch all reports for this user for dashboard
        (async () => {
          const allReports = await storageRequest('Reports');
          setUserReports((allReports || []).filter(r => r.userName === userName || r.userName === user.email));
        })();
      }, [user, userName]);

      useEffect(() => {
        // Render dashboard bar chart
        if (activeTab !== 'dashboard') return;
        if (!userReports.length || !Chart) return;
        const completed = userReports.reduce((sum, r) => sum + (Number(r.completedCount) || 0), 0);
        const pending = userReports.reduce((sum, r) => sum + (Number(r.pendingCount) || 0), 0);

        const canvas = document.getElementById('userDashboardBarChart');
        if (!canvas) return;

        if (dashboardChartRef.current) dashboardChartRef.current.destroy();

        try {
          dashboardChartRef.current = new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
              labels: ['Completed', 'Pending'],
              datasets: [{
                label: 'Test Cases',
                data: [completed, pending],
                backgroundColor: ['#10b981', '#f59e0b']
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        } catch (err) {
          // ignore chart errors
        }

        return () => {
          if (dashboardChartRef.current) {
            dashboardChartRef.current.destroy();
            dashboardChartRef.current = null;
          }
        };
      }, [activeTab, userReports]);

      // ...existing code for session, timer, etc...

      // User dashboard summary calculations
      const totalProjects = userReports.length;
      const totalCompleted = userReports.reduce((sum, r) => sum + (Number(r.completedCount) || 0), 0);
      const totalPending = userReports.reduce((sum, r) => sum + (Number(r.pendingCount) || 0), 0);
      const totalTestCases = totalCompleted + totalPending;
      const totalTime = userReports.reduce((sum, r) => sum + (Number(r.timeSpent) || 0), 0);
      const avgTimePerProject = totalProjects > 0 ? Math.round(totalTime / totalProjects) : 0;
      const completionRate = totalTestCases > 0 ? Math.round((totalCompleted / totalTestCases) * 100) : 0;

      useEffect(() => {
        const loadSession = async () => {
          try {
            const session = JSON.parse(localStorage.getItem('userSession') || '{}');
            if (session.userName && session.projectName && session.phase) {
              setUserName(session.userName);
              setProjectName(session.projectName);
              setPhase(session.phase);
              setShowPopup(false);
              const storedGroups = await storageRequest('Groups');
              setGroups(storedGroups.filter(g => g.phase === session.phase) || []);
              setTimer(session.timer || 0);
              setIsRunning(session.isRunning || false);
              setCompleted(session.completed || {});
              setSelectedGroup(session.selectedGroup || null);
              if (session.selectedGroup) {
                const storedTestCases = await storageRequest('TestCases');
                setTestCases(storedTestCases.filter(tc => tc.groupId === session.selectedGroup) || []);
              }
            }
          } catch (err) {
            setError('Failed to load session. Check console.');
            console.error('Error in UserDashboard:', err);
          }
        };
        loadSession();
      }, []);

      useEffect(() => {
        let interval;
        if (isRunning) {
          interval = setInterval(() => {
            setTimer(prev => {
              const newTimer = prev + 1;
              localStorage.setItem('userSession', JSON.stringify({
                userName,
                projectName,
                phase,
                timer: newTimer,
                isRunning,
                completed,
                selectedGroup
              }));
              return newTimer;
            });
          }, 1000);
        }
        return () => clearInterval(interval);
      }, [isRunning, userName, projectName, phase, completed, selectedGroup]);

      useEffect(() => {
        if (!showReport || !reportData) return;

        const canvas = document.getElementById('userReportChart');
        if (!canvas) {
          setError('Chart canvas element not found');
          console.error('Chart canvas not found for user report');
          return;
        }

        const ctx = canvas.getContext('2d');
        if (!ctx) {
          setError('Failed to get 2D context for chart');
          console.error('Failed to get 2D context for user report chart');
          return;
        }

        if (!Chart) {
          setError('Chart.js library failed to load');
          console.error('Chart.js not available');
          return;
        }

        // Destroy previous chart instance if it exists
        if (chartRef.current) {
          chartRef.current.destroy();
        }

        try {
          chartRef.current = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: ['Test Cases'],
              datasets: [
                {
                  label: 'Completed',
                  data: [reportData.completedCount],
                  backgroundColor: '#10b981',
                },
                {
                  label: 'Pending',
                  data: [reportData.pendingCount],
                  backgroundColor: '#f59e0b',
                }
              ]
            },
            options: {
              scales: {
                y: { beginAtZero: true }
              },
              responsive: true,
              maintainAspectRatio: false
            }
          });
        } catch (err) {
          setError('Failed to render report chart. Check console.');
          console.error('Error rendering user report chart:', err);
        }

        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
            chartRef.current = null;
          }
        };
      }, [showReport, reportData]);

      const handlePopupSubmit = async () => {
        if (!userName || !projectName || !phase) {
          setError('User name, project name, and phase are required');
          return;
        }
        try {
          setShowPopup(false);
          setError('');
          const storedGroups = await storageRequest('Groups');
          setGroups(storedGroups.filter(g => g.phase === phase) || []);
          localStorage.setItem('userSession', JSON.stringify({
            userName,
            projectName,
            phase,
            timer: 0,
            isRunning: false,
            completed: {},
            selectedGroup: null
          }));
        } catch (err) {
          setError('Failed to save session. Check console.');
          console.error('Error in handlePopupSubmit:', err);
        }
      };

      const handlePopupClose = () => {
        setShowPopup(false);
        setUserName('');
        setProjectName('');
        setPhase('');
        setError('');
      };

      const handleGroupSelect = async (groupId) => {
        try {
          setSelectedGroup(groupId);
          const storedTestCases = await storageRequest('TestCases');
          setTestCases(storedTestCases.filter(tc => tc.groupId === groupId) || []);
          localStorage.setItem('userSession', JSON.stringify({
            userName,
            projectName,
            phase,
            timer,
            isRunning,
            completed,
            selectedGroup: groupId
          }));
          setError('');
        } catch (err) {
          setError('Failed to load test cases. Check console.');
          console.error('Error in handleGroupSelect:', err);
        }
      };

      const handleBackToGroups = () => {
        setSelectedGroup(null);
        setTestCases([]);
        localStorage.setItem('userSession', JSON.stringify({
          userName,
          projectName,
          phase,
          timer,
          isRunning,
          completed,
          selectedGroup: null
        }));
      };

      const handleStartProject = () => {
        setIsRunning(true);
        localStorage.setItem('userSession', JSON.stringify({
          userName,
          projectName,
          phase,
          timer,
          isRunning: true,
          completed,
          selectedGroup
        }));
      };

      const handleEndProject = async () => {
        try {
          setIsRunning(false);
          const completedCount = Object.values(completed).filter(v => v).length;
          const pendingCount = testCases.length - completedCount;
          const pendingTestCases = testCases
            .filter((_, idx) => !completed[idx])
            .map(tc => tc.title)
            .join(', ');
          const newReport = {
            id: generateUUID(),
            userName,
            projectName,
            phase,
            completedCount,
            pendingCount,
            pendingTestCases,
            timeSpent: timer
          };
          await storageRequest('Reports', 'POST', [newReport]);
          setReportData(newReport);
          setShowReport(true);
          localStorage.removeItem('userSession');
          setSelectedGroup(null);
          setTestCases([]);
          setTimer(0);
          setCompleted({});
          setError('');
        } catch (err) {
          setError('Failed to save report. Check console.');
          console.error('Error in handleEndProject:', err);
        }
      };

      const handleCloseReport = () => {
        setShowReport(false);
        setShowPopup(true);
        setUserName('');
        setProjectName('');
        setPhase('');
        setReportData(null);
      };

      const handleCheckboxChange = (index) => {
        setCompleted(prev => {
          const newCompleted = { ...prev, [index]: !prev[index] };
          localStorage.setItem('userSession', JSON.stringify({
            userName,
            projectName,
            phase,
            timer,
            isRunning,
            completed: newCompleted,
            selectedGroup
          }));
          return newCompleted;
        });
      };

      const handleLogout = () => {
        localStorage.removeItem('currentUser');
        localStorage.removeItem('userSession');
        window.location.reload();
      };

      // Track if a session is in progress
      const [hasSession, setHasSession] = useState(false);

      useEffect(() => {
        const session = JSON.parse(localStorage.getItem('userSession') || '{}');
        setHasSession(!!(session.userName && session.projectName && session.phase));
      }, [showPopup, showReport]);

      return React.createElement(
        'div',
        { className: 'flex min-h-screen' },
        React.createElement(
          'div',
          { className: 'w-64 bg-white p-6 shadow-sm' },
          React.createElement('h2', { className: 'text-xl font-semibold mb-6 text-gray-800' }, 'TestCase Manager'),
          React.createElement(
            'nav',
            null,
            React.createElement(
              'button',
              {
                onClick: () => setActiveTab('dashboard'),
                className: `w-full text-left px-4 py-3 rounded-lg sidebar-item mb-2 flex items-center ${activeTab === 'dashboard' ? 'bg-gray-100 text-gray-800' : 'text-gray-600'}`
              },
              React.createElement('svg', { className: 'w-5 h-5 mr-2', fill: 'currentColor', viewBox: '0 0 20 20' }, React.createElement('path', { d: 'M10 2L2 6v12h16V6l-8-4zm0 2.828l5.172 2.586V16H4.828V7.414L10 4.828z' })),
              'Dashboard'
            ),
            React.createElement(
              'button',
              {
                onClick: () => setActiveTab('execution'),
                className: `w-full text-left px-4 py-3 rounded-lg sidebar-item mb-2 flex items-center ${activeTab === 'execution' ? 'bg-gray-100 text-gray-800' : 'text-gray-600'}`
              },
              React.createElement('svg', { className: 'w-5 h-5 mr-2', fill: 'currentColor', viewBox: '0 0 20 20' }, React.createElement('path', { d: 'M2 3h16v14H2V3zm4 8h2v4H6v-4zm4-4h2v8h-2V7zm4 2h2v6h-2V9z' })),
              'Test Execution'
            )
          )
        ),
        React.createElement(
          'div',
          { className: 'flex-1 p-8' },
          React.createElement(
            'div',
            { className: 'flex justify-between items-center mb-6' },
            React.createElement('h1', { className: 'text-2xl font-bold text-gray-800' }, 'Test Case Management System'),
            React.createElement(
              'div',
              { className: 'flex items-center space-x-3' },
              React.createElement(
                'div',
                { className: 'flex items-center space-x-2' },
                React.createElement(
                  'div',
                  { className: 'w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center' },
                  React.createElement('svg', { className: 'w-5 h-5 text-gray-600', fill: 'currentColor', viewBox: '0 0 20 20' }, React.createElement('path', { d: 'M10 10a4 4 0 100-8 4 4 0 000 8zm0 2a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6z' }))
                ),
                React.createElement('span', { className: 'text-gray-700' }, user.role)
              ),
              React.createElement(
                'button',
                {
                  onClick: handleLogout,
                  className: 'text-gray-600 hover:text-gray-800 flex items-center'
                },
                React.createElement('svg', { className: 'w-5 h-5 mr-1', fill: 'currentColor', viewBox: '0 0 20 20' }, React.createElement('path', { d: 'M3 3h14v14H3V3zm10 6h4v2h-4v4l-4-4 4-4v4z' })),
                'Logout'
              )
            )
          ),
          // --- Always render the popup if showPopup is true ---
          showPopup && React.createElement(
            'div',
            { className: 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50' },
            React.createElement(
              'div',
              { className: 'bg-white p-6 rounded-lg custom-shadow w-96' },
              React.createElement(
                'div',
                { className: 'modal-scroll' },
                React.createElement(
                  'div',
                  { className: 'flex justify-between items-center mb-4' },
                  React.createElement('h3', { className: 'text-lg font-semibold text-gray-800' }, 'Start New Test Execution'),
                  React.createElement(
                    'button',
                    { onClick: handlePopupClose, className: 'text-gray-600 hover:text-gray-800' },
                    React.createElement('svg', { className: 'w-5 h-5', fill: 'currentColor', viewBox: '0 0 20 20' }, React.createElement('path', { d: 'M6 6l8 8m0-8l-8 8' }))
                  )
                ),
                React.createElement('label', { className: 'block text-sm text-gray-600 mb-2' }, 'User Name'),
                React.createElement('input', {
                  type: 'text',
                  placeholder: 'Enter your name',
                  value: userName,
                  onChange: (e) => setUserName(e.target.value),
                  className: 'w-full p-3 border rounded-lg input-focus mb-4'
                }),
                React.createElement('label', { className: 'block text-sm text-gray-600 mb-2' }, 'Project Name'),
                React.createElement('input', {
                  type: 'text',
                  placeholder: 'Enter project name',
                  value: projectName,
                  onChange: (e) => setProjectName(e.target.value),
                  className: 'w-full p-3 border rounded-lg input-focus mb-4'
                }),
                React.createElement('label', { className: 'block text-sm text-gray-600 mb-2' }, 'Phase'),
                React.createElement(
                  'select',
                  {
                    value: phase,
                    onChange: (e) => setPhase(e.target.value),
                    className: 'w-full p-3 border rounded-lg input-focus mb-4'
                  },
                  React.createElement('option', { value: '' }, 'Select a phase'),
                  PHASES.map(phaseOption =>
                    React.createElement('option', { key: phaseOption.value, value: phaseOption.value }, phaseOption.label)
                  )
                ),
                React.createElement(
                  'button',
                  {
                    onClick: handlePopupSubmit,
                    className: 'w-full bg-blue-900 text-white p-3 rounded-lg hover:bg-blue-800 transition'
                  },
                  'Start Execution'
                )
              )
            )
          ),
          // --- End popup always rendered ---

          // --- Show project summary and graph after project ends ---
          showReport && reportData && React.createElement(
            'div',
            { className: 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50' },
            React.createElement(
              'div',
              { className: 'bg-white p-6 rounded-lg custom-shadow w-full max-w-lg' },
              React.createElement(
                'div',
                { className: 'modal-scroll' },
                React.createElement(
                  'div',
                  { className: 'flex justify-between items-center mb-4' },
                  React.createElement('h3', { className: 'text-lg font-semibold text-gray-800' }, 'Test Execution Report'),
                  React.createElement(
                    'button',
                    { onClick: handleCloseReport, className: 'text-gray-600 hover:text-gray-800' },
                    React.createElement('svg', { className: 'w-5 h-5', fill: 'currentColor', viewBox: '0 0 20 20' }, React.createElement('path', { d: 'M6 6l8 8m0-8l-8 8' }))
                  )
                ),
                React.createElement('p', { className: 'text-gray-600 mb-4' }, 'Project: ', reportData.projectName, ', Phase: ', reportData.phase),
                React.createElement(
                  'div',
                  { className: 'chart-container mb-6' },
                  React.createElement('canvas', { id: 'userReportChart' })
                ),
                React.createElement(
                  'div',
                  { className: 'space-y-2' },
                  React.createElement('p', { className: 'text-gray-600' }, 'Total Test Cases: ', React.createElement('span', { className: 'font-semibold' }, reportData.completedCount + reportData.pendingCount)),
                  React.createElement('p', { className: 'text-gray-600' }, 'Completed: ', React.createElement('span', { className: 'font-semibold text-green-600' }, reportData.completedCount)),
                  React.createElement('p', { className: 'text-gray-600' }, 'Pending: ', React.createElement('span', { className: 'font-semibold text-yellow-600' }, reportData.pendingCount)),
                  React.createElement('p', { className: 'text-gray-600' }, 'Time Spent: ', React.createElement('span', { className: 'font-semibold' }, Math.floor(reportData.timeSpent / 60), 'm ', reportData.timeSpent % 60, 's'))
                ),
                React.createElement(
                  'button',
                  {
                    onClick: handleCloseReport,
                    className: 'w-full bg-blue-900 text-white p-3 rounded-lg hover:bg-blue-800 transition mt-4'
                  },
                  'Start New Project'
                )
              )
            )
          ),
          // --- End project summary and graph ---

          activeTab === 'dashboard' && React.createElement(
            'div',
            null,
            React.createElement('h2', { className: 'text-xl font-bold mb-4 text-gray-800' }, 'User Dashboard Overview'),
            React.createElement(
              'div',
              { className: 'grid grid-cols-1 md:grid-cols-3 gap-6 mb-6' },
              React.createElement(
                'div',
                { className: 'bg-white p-6 rounded-lg custom-shadow' },
                React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-2' }, 'Projects Completed'),
                React.createElement('p', { className: 'text-3xl font-bold text-gray-800' }, totalProjects)
              ),
              React.createElement(
                'div',
                { className: 'bg-white p-6 rounded-lg custom-shadow' },
                React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-2' }, 'Avg Time per Project'),
                React.createElement('p', { className: 'text-3xl font-bold text-gray-800' }, isNaN(avgTimePerProject) ? 'N/A' : `${Math.floor(avgTimePerProject / 60)}m ${avgTimePerProject % 60}s`)
              ),
              React.createElement(
                'div',
                { className: 'bg-white p-6 rounded-lg custom-shadow' },
                React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-2' }, 'Completion Rate'),
                React.createElement('p', { className: 'text-3xl font-bold text-gray-800' }, `${completionRate}%`)
              )
            ),
            React.createElement(
              'div',
              { className: 'bg-white p-6 rounded-lg custom-shadow mb-6' },
              React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-4' }, 'Completed vs Pending Test Cases'),
              React.createElement('canvas', { id: 'userDashboardBarChart', width: 400, height: 200 })
            ),
            // --- Resume Project Button ---
            hasSession && React.createElement(
              'div',
              { className: 'flex justify-end mb-4' },
              React.createElement(
                'button',
                {
                  className: 'bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition',
                  onClick: () => {
                    setShowPopup(false);
                    setActiveTab('execution');
                  }
                },
                'Resume Project'
              )
            ),
            // --- Start New Project Button ---
            React.createElement(
              'div',
              { className: 'flex justify-end mb-4' },
              React.createElement(
                'button',
                {
                  className: 'bg-blue-900 text-white px-4 py-2 rounded-lg hover:bg-blue-800 transition',
                  onClick: () => setShowPopup(true)
                },
                'Start a new project'
              )
            ),
            // --- Previous Reports Section ---
            React.createElement(
              'div',
              { className: 'bg-white p-6 rounded-lg custom-shadow' },
              React.createElement('h3', { className: 'text-lg font-semibold text-gray-800 mb-4' }, 'Previous Reports'),
              userReports && userReports.length > 0
                ? React.createElement(
                    'ul',
                    { className: 'divide-y' },
                    userReports.slice().reverse().map((r, idx) =>
                      React.createElement(
                        'li',
                        { key: r.id, className: 'py-3' },
                        React.createElement('span', { className: 'font-semibold text-gray-800' }, r.projectName),
                        ' (', r.phase, ') - ',
                        React.createElement('span', { className: 'text-green-600' }, 'Completed: ', r.completedCount),
                        ', ',
                        React.createElement('span', { className: 'text-yellow-600' }, 'Pending: ', r.pendingCount),
                        ', ',
                        React.createElement('span', { className: 'text-gray-600' }, 'Time: ', Math.floor(r.timeSpent / 60), 'm ', r.timeSpent % 60, 's')
                      )
                    )
                  )
                : React.createElement('p', { className: 'text-gray-600' }, 'No previous reports.')
            )
          ),
          activeTab === 'execution' && (
            // ...existing Test Execution UI...
            // (all code previously in UserDashboard except sidebar and header)
            // You can keep your previous execution UI code here.
            // ...existing code...
            [
              React.createElement('p', { className: 'text-gray-600 mb-4' }, 'Project: ', projectName, ', Phase: ', phase),
              groups.length > 0
                ? !selectedGroup
                    ? React.createElement(
                        'div',
                        { className: 'space-y-4' },
                        React.createElement('h3', { className: 'text-lg font-semibold text-gray-800' }, 'Select a Test Group'),
                        groups.map(group =>
                          React.createElement(
                            'div',
                            { key: group.id, className: 'bg-white p-4 rounded-lg custom-shadow card-hover' },
                            React.createElement('h4', { className: 'font-semibold text-gray-800' }, group.name),
                            React.createElement('p', { className: 'text-gray-600' }, 'Description: ', group.description || 'None'),
                            React.createElement('p', { className: 'text-gray-600' }, 'Phase: ', group.phase),
                            React.createElement(
                              'button',
                              {
                                onClick: () => handleGroupSelect(group.id),
                                className: 'mt-2 bg-blue-900 text-white px-4 py-2 rounded-lg hover:bg-blue-800'
                              },
                              'Select Group'
                            )
                          )
                        )
                      )
                    : React.createElement(
                        'div',
                        null,
                        React.createElement(
                          'button',
                          {
                            onClick: handleBackToGroups,
                            className: 'bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 mb-4'
                          },
                          'Back to Groups'
                        ),
                        React.createElement('p', { className: 'text-gray-600 mb-4' }, 'Timer: ', Math.floor(timer / 60), 'm ', timer % 60, 's'),
                        !isRunning &&
                          React.createElement(
                            'button',
                            {
                              onClick: handleStartProject,
                              className: 'bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 mb-4'
                            },
                            'Start Timer'
                          ),
                        isRunning &&
                          React.createElement(
                            'button',
                            {
                              onClick: handleEndProject,
                              className: 'bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 mb-4'
                            },
                            'End Execution'
                          ),
                        testCases.length > 0
                          ? React.createElement(
                              'div',
                              { className: 'space-y-4' },
                              testCases.map((tc, idx) =>
                                React.createElement(
                                  'div',
                                  { key: tc.id, className: 'bg-white p-6 rounded-lg custom-shadow card-hover' },
                                  React.createElement(
                                    'div',
                                    { className: 'flex items-start' },
                                    React.createElement('input', {
                                      type: 'checkbox',
                                      checked: completed[idx] || false,
                                      onChange: () => handleCheckboxChange(idx),
                                      className: 'mr-3 mt-1'
                                    }),
                                    React.createElement(
                                      'div',
                                      null,
                                      React.createElement('h3', { className: 'font-semibold text-gray-800' }, tc.title),
                                      React.createElement(
                                        'ul',
                                        { className: 'ml-4 list-disc text-gray-700' },
                                        tc.steps.split('\n').map((step, stepIdx) =>
                                          React.createElement('li', { key: stepIdx }, step)
                                        )
                                      )
                                    )
                                  )
                                )
                              )
                            )
                          : React.createElement('p', { className: 'text-gray-600' }, 'No test cases available for this group.')
                      )
                : React.createElement('p', { className: 'text-gray-600' }, 'No test groups available for this phase. Contact your admin to create groups.')
            ]
          )
        )
      );
    }

    ReactDOM.render(React.createElement(App), document.getElementById('root'));
  </script>
</body>
</html>
